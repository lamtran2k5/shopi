# ----------------------------------------------------------------------
# Local ModSecurity configuration overrides
# ----------------------------------------------------------------------

# Enable ModSecurity in blocking mode
SecRuleEngine On

# Set the default anomaly threshold (lower = stricter)
SecAction \
  "id:900000,\
  phase:1,\
  pass,\
  nolog,\
  setvar:'tx.inbound_anomaly_score_threshold=5',\
  setvar:'tx.outbound_anomaly_score_threshold=4'"

# Set paranoia level (1 = minimal, 2 = stricter, 3/4 = very strict)
SecAction \
  "id:900100,\
  phase:1,\
  pass,\
  nolog,\
  setvar:'tx.paranoia_level=1'"

# ----------------------------------------------------------------------
# Custom rules
# ----------------------------------------------------------------------

# Block suspicious User-Agent strings (example: SQLMap scanner)
SecRule REQUEST_HEADERS:User-Agent "@contains sqlmap" \
  "id:100001,\
  phase:1,\
  deny,\
  log,\
  msg:'Blocked SQLMap scanner User-Agent'"

# Block attempts to access sensitive files directly
SecRule REQUEST_URI "@rx \.(env|git|htaccess)$" \
  "id:100002,\
  phase:2,\
  deny,\
  log,\
  msg:'Blocked direct access to sensitive file extensions'"

# Block overly long query strings (potential DoS or fuzzing)
SecRule QUERY_STRING "@length > 2000" \
  "id:100003,\
  phase:2,\
  deny,\
  log,\
  msg:'Blocked request with excessively long query string'"

# ----------------------------------------------------------------------
# Example exclusion: allow /safe-upload route to bypass XSS rule 941110
# ----------------------------------------------------------------------
SecRule REQUEST_URI "@beginsWith /safe-upload" \
  "id:100004,\
  phase:1,\
  pass,\
  nolog,\
  ctl:ruleRemoveById=941110"
